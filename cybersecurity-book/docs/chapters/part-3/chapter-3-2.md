# –ì–ª–∞–≤–∞ 3.2: Active Directory –∏ Kerberos

## üéØ –¶–µ–ª–∏ –≥–ª–∞–≤—ã

- –ü–æ–Ω—è—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É Active Directory: –¥–æ–º–µ–Ω, –ª–µ—Å, OU, –æ–±—ä–µ–∫—Ç—ã
- –ó–Ω–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã AD –∏ –∏—Ö —Ä–æ–ª—å –≤ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ
- –ü–æ–Ω–∏–º–∞—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –≥—Ä—É–ø–ø–æ–≤—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ (GPO)
- –ó–Ω–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª LDAP –∏ Distinguished Name
- –†–∞–∑–±–∏—Ä–∞—Ç—å—Å—è –≤ Kerberos-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ—à–∞–≥–æ–≤–æ
- –ü–æ–Ω–∏–º–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –∞—Ç–∞–∫–∏ –Ω–∞ Kerberos –Ω–∞ —É—Ä–æ–≤–Ω–µ SOC
- –ó–Ω–∞—Ç—å Event ID –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è Kerberos-–∞—Ç–∞–∫

---

## 3.2.1 –ß—Ç–æ —Ç–∞–∫–æ–µ Active Directory

Active Directory (AD) ‚Äî —ç—Ç–æ —Å–ª—É–∂–±–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –æ—Ç Microsoft, –∫–æ—Ç–æ—Ä–∞—è —Ö—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–±–æ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–∞—Ö –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å–µ—Ç–∏: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö, –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö, –≥—Ä—É–ø–ø–∞—Ö, –ø—Ä–∏–Ω—Ç–µ—Ä–∞—Ö, –ø–æ–ª–∏—Ç–∏–∫–∞—Ö. AD –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ –¥–æ–º–µ–Ω–µ Windows.

–ë–µ–∑ AD –∫–∞–∂–¥—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ ‚Äî —ç—Ç–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è **—Ä–∞–±–æ—á–∞—è –≥—Ä—É–ø–ø–∞ (Workgroup)**. –° AD ‚Äî –æ–¥–Ω–∞ —É—á—ë—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å `john.doe@corp.local` —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ –¥–æ–º–µ–Ω–∞.

### –î–æ–º–µ–Ω (Domain)

–î–æ–º–µ–Ω ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ AD. –≠—Ç–æ –ª–æ–≥–∏—á–µ—Å–∫–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤) –ø–æ–¥ –æ–¥–Ω–∏–º DNS-–∏–º–µ–Ω–µ–º.

```
corp.local       ‚Üê DNS-–∏–º—è –¥–æ–º–µ–Ω–∞ (FQDN)
CORP             ‚Üê NetBIOS-–∏–º—è –¥–æ–º–µ–Ω–∞
```

–í –∫–∞–∂–¥–æ–º –¥–æ–º–µ–Ω–µ –µ—Å—Ç—å –º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω **Domain Controller (DC)** ‚Äî —Å–µ—Ä–≤–µ—Ä —Å —Ä–æ–ª—å—é AD DS (Active Directory Domain Services). DC —Ö—Ä–∞–Ω–∏—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö AD (`NTDS.dit`), –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ —Ö—Ä–∞–Ω–∏—Ç –∫–ª—é—á–∏ Kerberos.

### –õ–µ—Å (Forest) –∏ –î–µ—Ä–µ–≤–æ –¥–æ–º–µ–Ω–æ–≤ (Tree)

```
Forest: company.com
  ‚îÇ
  ‚îú‚îÄ‚îÄ Tree 1: company.com (–∫–æ—Ä–Ω–µ–≤–æ–π –¥–æ–º–µ–Ω)
  ‚îÇ     ‚îú‚îÄ‚îÄ europe.company.com (–¥–æ—á–µ—Ä–Ω–∏–π –¥–æ–º–µ–Ω)
  ‚îÇ     ‚îî‚îÄ‚îÄ asia.company.com
  ‚îÇ
  ‚îî‚îÄ‚îÄ Tree 2: subsidiary.com (–¥—Ä—É–≥–∞—è –∫–æ–º–ø–∞–Ω–∏—è –≤ —Ç–æ–º –∂–µ –ª–µ—Å—É)
```

- **Forest** ‚Äî –≤—ã—Å—à–∏–π —É—Ä–æ–≤–µ–Ω—å –∏–µ—Ä–∞—Ä—Ö–∏–∏. –í—Å–µ –¥–æ–º–µ–Ω—ã –≤ –ª–µ—Å—É –¥–æ–≤–µ—Ä—è—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É (transitive trust).
- **Tree** ‚Äî –¥–µ—Ä–µ–≤–æ –¥–æ–º–µ–Ω–æ–≤ —Å –æ–±—â–∏–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ–º –∏–º—ë–Ω DNS.
- **Domain** ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –¥–æ–º–µ–Ω –≤–Ω—É—Ç—Ä–∏ –¥–µ—Ä–µ–≤–∞.

–î–ª—è SOC –≤–∞–∂–Ω–æ: **–ª–µ—Å** ‚Äî –≥—Ä–∞–Ω–∏—Ü–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –°–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ–º–µ–Ω –º–æ–∂–µ—Ç –¥–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º—É –ª–µ—Å—É —á–µ—Ä–µ–∑ trust-–æ—Ç–Ω–æ—à–µ–Ω–∏—è.

### –†–æ–ª–∏ DC (FSMO Roles)

–í –ª–µ—Å—É/–¥–æ–º–µ–Ω–µ –µ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–æ–ª–∏ DC:
- **PDC Emulator** ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–∞—Ä–æ–ª–µ–π, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤—Ä–µ–º–µ–Ω–∏
- **RID Master** ‚Äî –≤—ã–¥–∞—ë—Ç –¥–∏–∞–ø–∞–∑–æ–Ω—ã RID –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤
- **Infrastructure Master** ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫–∏ –º–µ–∂–¥—É –¥–æ–º–µ–Ω–∞–º–∏
- **Schema Master** ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ö–µ–º–æ–π AD (–æ–¥–∏–Ω –Ω–∞ –ª–µ—Å)
- **Domain Naming Master** ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç –∏–º–µ–Ω–∞–º–∏ –¥–æ–º–µ–Ω–æ–≤ (–æ–¥–∏–Ω –Ω–∞ –ª–µ—Å)

---

## 3.2.2 –û–±—ä–µ–∫—Ç—ã Active Directory

–í—Å—ë –≤ AD ‚Äî –æ–±—ä–µ–∫—Ç. –ö–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç –∏–º–µ–µ—Ç –∫–ª–∞—Å—Å (user, computer, group...) –∏ –Ω–∞–±–æ—Ä –∞—Ç—Ä–∏–±—É—Ç–æ–≤.

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (Users)

```
–ö–ª–∞—Å—Å:     user
–ê—Ç—Ä–∏–±—É—Ç—ã:
  sAMAccountName: john.doe       ‚Üê –∏–º—è –¥–ª—è –≤—Ö–æ–¥–∞ (pre-Windows 2000)
  userPrincipalName: john.doe@corp.local  ‚Üê UPN (email-—Ñ–æ—Ä–º–∞—Ç)
  distinguishedName: CN=John Doe,OU=IT,DC=corp,DC=local
  memberOf: [CN=IT-Staff,...], [CN=VPN-Users,...]
  lastLogon: 133500234567890000  (100-ns –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã —Å 1601-01-01)
  pwdLastSet: 133499234567890000
  userAccountControl: 512        ‚Üê —Ñ–ª–∞–≥–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
```

**userAccountControl ‚Äî –≤–∞–∂–Ω—ã–µ —Ñ–ª–∞–≥–∏:**

| –ó–Ω–∞—á–µ–Ω–∏–µ | –§–ª–∞–≥ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|------|----------|
| 0x0002 | ACCOUNTDISABLE | –ê–∫–∫–∞—É–Ω—Ç –æ—Ç–∫–ª—é—á—ë–Ω |
| 0x0010 | LOCKOUT | –ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω |
| 0x0020 | PASSWD_NOTREQD | –ü–∞—Ä–æ–ª—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è |
| 0x0040 | PASSWD_CANT_CHANGE | –ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å –ø–∞—Ä–æ–ª—å |
| 0x0200 | NORMAL_ACCOUNT | –û–±—ã—á–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç |
| 0x10000 | DONT_EXPIRE_PASSWORD | –ü–∞—Ä–æ–ª—å –Ω–µ –∏—Å—Ç–µ–∫–∞–µ—Ç |
| 0x400000 | **DONT_REQ_PREAUTH** | –ù–µ —Ç—Ä–µ–±—É–µ—Ç Kerberos –ø—Ä–µ-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é ‚Üí AS-REP Roasting! |

### –ö–æ–º–ø—å—é—Ç–µ—Ä—ã (Computers)

–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã ‚Äî —ç—Ç–æ —Ç–æ–∂–µ –∞–∫–∫–∞—É–Ω—Ç—ã! –ò–º—è –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ `$`:
```
sAMAccountName: WORKSTATION01$
distinguishedName: CN=WORKSTATION01,OU=Workstations,DC=corp,DC=local
```

–ú–∞—à–∏–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∏–º–µ—é—Ç —Å–≤–æ–∏ –ø–∞—Ä–æ–ª–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–µ–Ω—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 –¥–Ω–µ–π). –ü—Ä–∏ Pass-the-Hash –∞—Ç–∞–∫–∞—Ö –∏–Ω–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–∞—à–∏–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã.

### –ì—Ä—É–ø–ø—ã (Groups)

**–ü–æ —Ç–∏–ø—É:**
- **Security** ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (–¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ ACL)
- **Distribution** ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è email-—Ä–∞—Å—Å—ã–ª–æ–∫ (Exchange)

**–ü–æ –æ–±–ª–∞—Å—Ç–∏ –¥–µ–π—Å—Ç–≤–∏—è:**
- **Domain Local** ‚Äî –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ —Å–≤–æ—ë–º –¥–æ–º–µ–Ω–µ, –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã –∏–∑ –ª—é–±—ã—Ö –¥–æ–º–µ–Ω–æ–≤
- **Global** ‚Äî –≤–∏–¥–Ω–∞ –≤–æ –≤—Å—ë–º –ª–µ—Å—É, —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç—ã —Å–≤–æ–µ–≥–æ –¥–æ–º–µ–Ω–∞
- **Universal** ‚Äî –≤–∏–¥–Ω–∞ –≤–æ –≤—Å—ë–º –ª–µ—Å—É, —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—ä–µ–∫—Ç—ã –∏–∑ –ª—é–±—ã—Ö –¥–æ–º–µ–Ω–æ–≤

**–ü—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã:**

| –ì—Ä—É–ø–ø–∞ | –ü—Ä–∏–≤–∏–ª–µ–≥–∏–∏ |
|--------|-----------|
| Domain Admins | –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –¥–æ–º–µ–Ω–æ–º |
| Enterprise Admins | –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ª–µ—Å–æ–º |
| Schema Admins | –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã AD |
| Administrators | –õ–æ–∫–∞–ª—å–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã DC |
| Account Operators | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ |
| Backup Operators | –ü—Ä–∞–≤–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è |
| Remote Desktop Users | RDP-–¥–æ—Å—Ç—É–ø |

### Organizational Units (OU)

OU ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤ AD. –ü–æ–∑–≤–æ–ª—è—é—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å GPO –∫ –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤—É –æ–±—ä–µ–∫—Ç–æ–≤ –∏ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∞.

```
corp.local
‚îú‚îÄ‚îÄ OU=IT
‚îÇ   ‚îú‚îÄ‚îÄ OU=Servers
‚îÇ   ‚îú‚îÄ‚îÄ OU=Workstations
‚îÇ   ‚îî‚îÄ‚îÄ OU=ServiceAccounts
‚îú‚îÄ‚îÄ OU=HR
‚îÇ   ‚îî‚îÄ‚îÄ OU=Workstations
‚îî‚îÄ‚îÄ OU=Finance
    ‚îú‚îÄ‚îÄ OU=Users
    ‚îî‚îÄ‚îÄ OU=Workstations
```

**–û—Ç–ª–∏—á–∏–µ OU –æ—Ç Groups:** OU ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫, Group ‚Äî –º–µ—Ö–∞–Ω–∏–∑–º –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞.

---

## 3.2.3 –ì—Ä—É–ø–ø–æ–≤—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ (GPO)

Group Policy Object (GPO) ‚Äî –Ω–∞–±–æ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫, –ø—Ä–∏–º–µ–Ω—è–µ–º—ã—Ö –∫ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ AD.

### –ß—Ç–æ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ GPO

- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ø–æ–ª–∏—Ç–∏–∫–∞ –ø–∞—Ä–æ–ª–µ–π, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ:** —É—Å—Ç–∞–Ω–æ–≤–∫–∞, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ –ü–û
- **–°–∫—Ä–∏–ø—Ç—ã:** –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –≤—Ö–æ–¥–µ/–≤—ã—Ö–æ–¥–µ, —Å—Ç–∞—Ä—Ç–µ/–æ—Å—Ç–∞–Ω–æ–≤–µ —Å–∏—Å—Ç–µ–º—ã
- **–†–µ–µ—Å—Ç—Ä:** –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–µ—Å—Ç—Ä–∞ –¥–ª—è –º–∞—à–∏–Ω –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ USB, –∑–∞–ø—Ä–µ—Ç –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º (AppLocker/SRP)
- **–ê—É–¥–∏—Ç:** –≤–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞—É–¥–∏—Ç–∞ —Å–æ–±—ã—Ç–∏–π

### –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è GPO (LSDOU)

GPO –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ (–∫–∞–∂–¥—ã–π —Å–ª–µ–¥—É—é—â–∏–π –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–π):
1. **L**ocal ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
2. **S**ite ‚Äî –ø–æ–ª–∏—Ç–∏–∫–∏ AD-—Å–∞–π—Ç–∞
3. **D**omain ‚Äî –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ–º–µ–Ω–∞ (–ø—Ä–∏–º–µ—Ä: Default Domain Policy)
4. **OU** ‚Äî –ø–æ–ª–∏—Ç–∏–∫–∏ OU (–æ—Ç –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –∫ –¥–æ—á–µ—Ä–Ω–µ–º—É)

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –ø–æ–±–µ–∂–¥–∞–µ—Ç. OU-–ø–æ–ª–∏—Ç–∏–∫–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –¥–æ–º–µ–Ω-–ø–æ–ª–∏—Ç–∏–∫–∏.

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö GPO

```cmd
gpresult /r           # –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç –≤ –∫–æ–Ω—Å–æ–ª–∏
gpresult /h gpo.html  # –ø–æ–¥—Ä–æ–±–Ω—ã–π HTML-–æ—Ç—á—ë—Ç
rsop.msc             # Resultant Set of Policy ‚Äî GUI
```

---

## 3.2.4 LDAP ‚Äî –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–æ—Å—Ç—É–ø–∞ –∫ AD

Lightweight Directory Access Protocol (LDAP) ‚Äî –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö –≤ AD. –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É **389** (LDAP) –∏–ª–∏ **636** (LDAPS —Å TLS).

### Distinguished Name (DN)

DN ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –æ–±—ä–µ–∫—Ç–∞ –≤ AD, –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –µ–≥–æ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å:

```
CN=John Doe,OU=IT,OU=Users,DC=corp,DC=local
‚îÇ              ‚îÇ              ‚îÇ
‚îÇ              ‚îÇ              ‚îî‚îÄ‚îÄ Domain Component (—á–∞—Å—Ç—å DNS-–∏–º–µ–Ω–∏)
‚îÇ              ‚îî‚îÄ‚îÄ Organizational Unit
‚îî‚îÄ‚îÄ Common Name (–∏–º—è –æ–±—ä–µ–∫—Ç–∞)
```

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã DN:
- `CN` ‚Äî Common Name (–∏–º—è –æ–±—ä–µ–∫—Ç–∞)
- `OU` ‚Äî Organizational Unit
- `DC` ‚Äî Domain Component (—á–∞—Å—Ç—å DNS-–∏–º–µ–Ω–∏ –¥–æ–º–µ–Ω–∞)
- `O` ‚Äî Organization (—Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

**–ü—Ä–∏–º–µ—Ä—ã DN:**
```
CN=Domain Admins,CN=Users,DC=corp,DC=local          ‚Üê –≥—Ä—É–ø–ø–∞
CN=WORKSTATION01,OU=Workstations,DC=corp,DC=local   ‚Üê –∫–æ–º–ø—å—é—Ç–µ—Ä
CN=Administrator,CN=Users,DC=corp,DC=local           ‚Üê –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
```

### LDAP-–∑–∞–ø—Ä–æ—Å—ã

LDAP –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –æ–±—ä–µ–∫—Ç–æ–≤. –ü—Ä–∏–º–µ—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤:

```ldap
# –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–º–µ–Ω–∞
(objectClass=user)

# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ sAMAccountName
(sAMAccountName=john.doe)

# –í—Å–µ —á–ª–µ–Ω—ã –≥—Ä—É–ø–ø—ã Domain Admins
(memberOf=CN=Domain Admins,CN=Users,DC=corp,DC=local)

# –í—Å–µ –æ—Ç–∫–ª—é—á—ë–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã
(&(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=2))

# –ê–∫–∫–∞—É–Ω—Ç—ã –±–µ–∑ –ø—Ä–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Kerberos (AS-REP Roastable!)
(&(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))

# –ê–∫–∫–∞—É–Ω—Ç—ã —Å SPN (Kerberoastable!)
(&(objectClass=user)(servicePrincipalName=*))
```

### –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å LDAP

```powershell
# PowerShell ‚Äî –ø–æ–∏—Å–∫ –≤ AD
Get-ADUser -Filter {SamAccountName -eq "john.doe"} -Properties *
Get-ADGroupMember -Identity "Domain Admins"
Get-ADComputer -Filter * -SearchBase "OU=Servers,DC=corp,DC=local"

# ldapsearch (Linux)
ldapsearch -H ldap://dc01.corp.local -D "john.doe@corp.local" \
           -w "Password123" -b "DC=corp,DC=local" "(objectClass=user)"
```

---

## 3.2.5 Kerberos ‚Äî –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —à–∞–≥ –∑–∞ —à–∞–≥–æ–º

Kerberos ‚Äî –ø—Ä–æ—Ç–æ–∫–æ–ª –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∏–ª–µ—Ç–æ–≤ (tickets). –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
- **–ü–∞—Ä–æ–ª—å –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –ø–æ —Å–µ—Ç–∏**
- –í–º–µ—Å—Ç–æ –ø–∞—Ä–æ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã** —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º —Å—Ä–æ–∫–æ–º –∂–∏–∑–Ω–∏
- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî **KDC (Key Distribution Center)**, –∫–æ—Ç–æ—Ä—ã–π –∂–∏–≤—ë—Ç –Ω–∞ DC

### –£—á–∞—Å—Ç–Ω–∏–∫–∏ Kerberos

- **Client** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ –∫–æ–º–ø—å—é—Ç–µ—Ä, –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—â–∏–π –¥–æ—Å—Ç—É–ø
- **KDC (Key Distribution Center)** ‚Äî DC, —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
  - **AS (Authentication Service)** ‚Äî –≤—ã–¥–∞—ë—Ç TGT
  - **TGS (Ticket Granting Service)** ‚Äî –≤—ã–¥–∞—ë—Ç Service Tickets
- **Service** ‚Äî —Ä–µ—Å—É—Ä—Å, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø (—Ñ–∞–π–ª–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä, SQL –∏ —Ç.–¥.)
- **krbtgt** ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç, —á–µ–π —Ö–µ—à –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –≤—Å–µ—Ö TGT

### –®–∞–≥ 1: AS-REQ ‚Äî –∑–∞–ø—Ä–æ—Å TGT

–ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –≤–æ–π—Ç–∏. –û–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ KDC (AS):

```
AS-REQ —Å–æ–¥–µ—Ä–∂–∏—Ç:
- –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ)
- –ò–º—è TGS-—Å–µ—Ä–≤–∏—Å–∞ (krbtgt/CORP.LOCAL)
- –í—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É, –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—É—é —Ö–µ—à–µ–º –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  (pre-authentication ‚Äî –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è)
- Nonce (—Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ)
```

–ü–æ—Ä—Ç: **UDP/TCP 88** (Kerberos)

### –®–∞–≥ 2: AS-REP ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ TGT

KDC –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É (—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç —Ö–µ—à–µ–º –ø–∞—Ä–æ–ª—è –∏–∑ AD). –ï—Å–ª–∏ OK:

```
AS-REP —Å–æ–¥–µ—Ä–∂–∏—Ç:
- Session Key (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω —Ö–µ—à–µ–º –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- TGT (Ticket Granting Ticket):
    –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω —Ö–µ—à–µ–º krbtgt
    –í–Ω—É—Ç—Ä–∏: –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, Session Key, PAC (Group memberships), –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏
```

**TGT** ‚Äî –∫–∞–∫ –ø–∞—Å–ø–æ—Ä—Ç. –ö–ª–∏–µ–Ω—Ç —Ö—Ä–∞–Ω–∏—Ç –µ–≥–æ –≤ –ø–∞–º—è—Ç–∏ (Credential Cache). –°—Ä–æ–∫ –∂–∏–∑–Ω–∏ ‚Äî 10 —á–∞—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é). TGT –Ω–µ–ª—å–∑—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–º ‚Äî —Ç–æ–ª—å–∫–æ KDC.

### –®–∞–≥ 3: TGS-REQ ‚Äî –∑–∞–ø—Ä–æ—Å Service Ticket

–ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Ñ–∞–π–ª–æ–≤–æ–º—É —Å–µ—Ä–≤–µ—Ä—É `FS01`. –û–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç TGS (—á–∞—Å—Ç—å KDC):

```
TGS-REQ —Å–æ–¥–µ—Ä–∂–∏—Ç:
- TGT (–∫–∞–∫ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –ª–∏—á–Ω–æ—Å—Ç–∏)
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞), –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π Session Key –∏–∑ TGT
- SPN (Service Principal Name) –Ω—É–∂–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞:
    cifs/FS01.corp.local  ‚Üê SMB –∫ —Ñ–∞–π–ª–æ–≤–æ–º—É —Å–µ—Ä–≤–µ—Ä—É
    http/webapp.corp.local
    MSSQLSvc/sql01.corp.local:1433
```

**SPN** ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ—Ä–≤–∏—Å–∞ –≤ AD. –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–≤–æ–π SPN.

### –®–∞–≥ 4: TGS-REP ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ Service Ticket

KDC —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç TGT —Å–≤–æ–∏–º –∫–ª—é—á–æ–º (—Ö–µ—à krbtgt), –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä:

```
TGS-REP —Å–æ–¥–µ—Ä–∂–∏—Ç:
- Service Session Key (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω Session Key –∏–∑ TGT ‚Äî –∫–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å)
- Service Ticket (ST):
    –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω —Ö–µ—à–µ–º –∞–∫–∫–∞—É–Ω—Ç–∞ —Å–µ—Ä–≤–∏—Å–∞ (FS01$)
    –í–Ω—É—Ç—Ä–∏: –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, PAC, Service Session Key, –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏
```

**–í–∞–∂–Ω–æ –¥–ª—è –∞—Ç–∞–∫:** Service Ticket –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω —Ö–µ—à–µ–º —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞. –ö–ª–∏–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –µ–≥–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å, –Ω–æ –º–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–ª—è –ª—é–±–æ–≥–æ SPN –∏ —É–Ω–µ—Å—Ç–∏ –æ—Ñ—Ñ–ª–∞–π–Ω ‚Äî –∏–º–µ–Ω–Ω–æ —ç—Ç–æ —ç–∫—Å–ø–ª—É–∞—Ç–∏—Ä—É–µ—Ç **Kerberoasting**.

### –®–∞–≥ 5: AP-REQ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Service Ticket

–ö–ª–∏–µ–Ω—Ç –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ —Ñ–∞–π–ª–æ–≤–æ–º—É —Å–µ—Ä–≤–µ—Ä—É:

```
AP-REQ —Å–æ–¥–µ—Ä–∂–∏—Ç:
- Service Ticket
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω Service Session Key)
```

–°–µ—Ä–≤–µ—Ä —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç Service Ticket —Å–≤–æ–∏–º —Ö–µ—à–µ–º, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç PAC (–≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) –∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

### –î–∏–∞–≥—Ä–∞–º–º–∞ Kerberos-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```
Client                    KDC (DC)                    Service (FS01)
  ‚îÇ                         ‚îÇ                              ‚îÇ
  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ AS-REQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                              ‚îÇ
  ‚îÇ     (username +         ‚îÇ                              ‚îÇ
  ‚îÇ      encrypted timestamp)‚îÇ                             ‚îÇ
  ‚îÇ                         ‚îÇ                              ‚îÇ
  ‚îÇ<‚îÄ‚îÄ‚îÄ AS-REP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                              ‚îÇ
  ‚îÇ     (TGT + Session Key) ‚îÇ                              ‚îÇ
  ‚îÇ                         ‚îÇ                              ‚îÇ
  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                              ‚îÇ
  ‚îÇ  Client stores TGT in   ‚îÇ                              ‚îÇ
  ‚îÇ  Kerberos ticket cache  ‚îÇ                              ‚îÇ
  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                              ‚îÇ
  ‚îÇ                         ‚îÇ                              ‚îÇ
  ‚îÇ  (later, accessing FS01)‚îÇ                              ‚îÇ
  ‚îÇ                         ‚îÇ                              ‚îÇ
  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ TGS-REQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                              ‚îÇ
  ‚îÇ     (TGT + SPN:         ‚îÇ                              ‚îÇ
  ‚îÇ      cifs/FS01)         ‚îÇ                              ‚îÇ
  ‚îÇ                         ‚îÇ                              ‚îÇ
  ‚îÇ<‚îÄ‚îÄ‚îÄ TGS-REP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                              ‚îÇ
  ‚îÇ     (Service Ticket +   ‚îÇ                              ‚îÇ
  ‚îÇ      Service Session Key)‚îÇ                             ‚îÇ
  ‚îÇ                         ‚îÇ                              ‚îÇ
  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ AP-REQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
  ‚îÇ                                    (Service Ticket +   ‚îÇ
  ‚îÇ                                     Authenticator)     ‚îÇ
  ‚îÇ                                                        ‚îÇ
  ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ AP-REP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
  ‚îÇ                                    (Optional mutual    ‚îÇ
  ‚îÇ                                     authentication)    ‚îÇ
```

### PAC (Privilege Attribute Certificate)

PAC ‚Äî —ç—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–Ω—É—Ç—Ä–∏ Service Ticket, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è:
- SID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- SID –≤—Å–µ—Ö –≥—Ä—É–ø–ø, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ—Å—Ç–æ–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- –í—Ä–µ–º—è –≤—Ö–æ–¥–∞
- –ü–æ–¥–ø–∏—Å–∞–Ω–∞ –∫–ª—é—á–∞–º–∏ KDC

–°–µ—Ä–≤–∏—Å —á–∏—Ç–∞–µ—Ç PAC –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –º–æ–∂–µ—Ç –¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å. –ê—Ç–∞–∫–∏ —Ç–∏–ø–∞ **Golden Ticket** –ø–æ–¥–¥–µ–ª—ã–≤–∞—é—Ç PAC.

---

## 3.2.6 –ê—Ç–∞–∫–∏ –Ω–∞ Kerberos ‚Äî –≤–∑–≥–ª—è–¥ SOC

### Pass-the-Ticket (PtT)

**–°—É—Ç—å:** –ö—Ä–∞–∂–∞ TGT –∏–ª–∏ Service Ticket –∏–∑ –ø–∞–º—è—Ç–∏ –º–∞—à–∏–Ω—ã –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–æ–π –º–∞—à–∏–Ω–µ.

**–ö–∞–∫:** –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ç–∏–ø–∞ `mimikatz` (–∫–æ–º–∞–Ω–¥–∞ `sekurlsa::tickets /export`) —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç –±–∏–ª–µ—Ç—ã –∏–∑ –ø–∞–º—è—Ç–∏. –ó–∞—Ç–µ–º `kerberos::ptt ticket.kirbi` ‚Äî –∏–º–ø–æ—Ä—Ç –Ω–∞ –∞—Ç–∞–∫—É—é—â–µ–π –º–∞—à–∏–Ω–µ.

**–í –ª–æ–≥–∞—Ö:**
```
Event 4624 ‚Äî Logon Type 3 –∏–ª–∏ 9
Event 4672 ‚Äî –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã
–í–∞–∂–Ω–æ: —Å–æ–±—ã—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –¥—Ä—É–≥–æ–π –º–∞—à–∏–Ω–µ, –Ω–µ —Ç–∞–º, –≥–¥–µ –±—ã–ª –≤—Ö–æ–¥
–ê–Ω–æ–º–∞–ª–∏—è: –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ LogonID –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö
```

**–ó–∞—â–∏—Ç–∞:** Protected Users group, Credential Guard (–∏–∑–æ–ª–∏—Ä—É–µ—Ç LSASS –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ).

---

### Kerberoasting

**–°—É—Ç—å:** –õ—é–±–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–º–µ–Ω–∞ –º–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å Service Ticket –¥–ª—è –ª—é–±–æ–≥–æ SPN. Service Ticket –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω —Ö–µ—à–µ–º —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞. –ê—Ç–∞–∫—É—é—â–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–∏–∫–µ—Ç –∏ –≤–∑–ª–∞–º—ã–≤–∞–µ—Ç —Ö–µ—à –æ—Ñ—Ñ–ª–∞–π–Ω.

**–®–∞–≥–∏ –∞—Ç–∞–∫–∏:**
1. –ù–∞–π—Ç–∏ –∞–∫–∫–∞—É–Ω—Ç—ã —Å SPN: `GetUserSPNs.py corp.local/user:password`
2. –ó–∞–ø—Ä–æ—Å–∏—Ç—å Service Tickets: `Rubeus kerberoast`
3. –ü–æ–ª—É—á–∏—Ç—å —Ö–µ—à–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `$krb5tgs$23$...`
4. –í–∑–ª–æ–º–∞—Ç—å –æ—Ñ—Ñ–ª–∞–π–Ω: `hashcat -m 13100 hashes.txt wordlist.txt`

**–í –ª–æ–≥–∞—Ö:**
```
Event ID 4769 ‚Äî Kerberos Service Ticket Requested
- TicketOptions: 0x40810000 (Renewable, Canonicalize, Renewable-OK)
- TicketEncryptionType: 0x17 (RC4-HMAC) ‚Üê RC4 –≤–º–µ—Å—Ç–æ AES –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ!
```

**–ü—Ä–∏–∑–Ω–∞–∫ Kerberoasting:** –ú–Ω–æ–∂–µ—Å—Ç–≤–æ 4769 –æ—Ç –æ–¥–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –∫ —Ä–∞–∑–Ω—ã–º SPN –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è. –ò–ª–∏ –∑–∞–ø—Ä–æ—Å ST —Å `EncryptionType = 0x17 (RC4)`, —Ç–æ–≥–¥–∞ –∫–∞–∫ –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö AD –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è AES.

**–ó–∞—â–∏—Ç–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã —Å –¥–ª–∏–Ω–Ω—ã–º–∏ —Ä–∞–Ω–¥–æ–º–Ω—ã–º–∏ –ø–∞—Ä–æ–ª—è–º–∏ (>25 —Å–∏–º–≤–æ–ª–æ–≤), –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Managed Service Accounts (gMSA), –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å 4769 —Å RC4.

---

### AS-REP Roasting

**–°—É—Ç—å:** –ï—Å–ª–∏ —É –∞–∫–∫–∞—É–Ω—Ç–∞ —Ñ–ª–∞–≥ `DONT_REQ_PREAUTH`, –º–æ–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å TGT –±–µ–∑ –∑–Ω–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è. –û—Ç–≤–µ—Ç AS-REP —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ, –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ö–µ—à–µ–º –ø–∞—Ä–æ–ª—è ‚Äî –≤–∑–ª–∞–º—ã–≤–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω.

**–£—Å–ª–æ–≤–∏–µ:** –ê–∫–∫–∞—É–Ω—Ç –∏–º–µ–µ—Ç `DONT_REQ_PREAUTH` (userAccountControl = 4194304).

**–í –ª–æ–≥–∞—Ö:**
```
Event ID 4768 ‚Äî Kerberos Authentication Service Request (AS-REQ)
- PreAuthType: 0 (–Ω–µ—Ç –ø—Ä–µ-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏!)
- Result Code: 0x0 (—É—Å–ø–µ—Ö) ‚Äî –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ñ–ª–∞–≥–∞ DONT_REQ_PREAUTH
```

**–ü—Ä–∏–∑–Ω–∞–∫:** 4768 —Å PreAuthType=0, –æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤.

**–ó–∞—â–∏—Ç–∞:** –ù–∞–π—Ç–∏ –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã —Å DONT_REQ_PREAUTH:
```powershell
Get-ADUser -Filter {DoesNotRequirePreAuth -eq $true} -Properties DoesNotRequirePreAuth
```

---

### Golden Ticket

**–°—É—Ç—å:** –ï—Å–ª–∏ –∞—Ç–∞–∫—É—é—â–∏–π –ø–æ–ª—É—á–∏–ª —Ö–µ—à NTLM –∞–∫–∫–∞—É–Ω—Ç–∞ `krbtgt`, –æ–Ω –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å TGT –æ—Ç –∏–º–µ–Ω–∏ –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ª—é–±—ã–º–∏ –≥—Ä—É–ø–ø–∞–º–∏, —Å –ª—é–±—ã–º —Å—Ä–æ–∫–æ–º –∂–∏–∑–Ω–∏.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –¥–æ–º–µ–Ω–æ–º, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–∞—Ä–æ–ª–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–º–µ–Ω–µ–Ω—ã. Golden Ticket —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–∫–∞ –Ω–µ —Å–º–µ–Ω—ë–Ω –ø–∞—Ä–æ–ª—å `krbtgt` (–ø—Ä–∏—á—ë–º –¥–≤–∞–∂–¥—ã ‚Äî –∏–∑-–∑–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–∞—Ä–æ–ª–µ–π AD).

**–í –ª–æ–≥–∞—Ö:**
```
Event ID 4624 ‚Äî Logon
- Account Domain: (–ø—É—Å—Ç–æ–µ –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –¥–æ–º–µ–Ω–∞)
- –ê–Ω–æ–º–∞–ª–∏—è: LogonType 3 –±–µ–∑ –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–µ–≥–æ 4776/4768
```

–ó–æ–ª–æ—Ç—ã–µ –±–∏–ª–µ—Ç—ã —Å–ª–æ–∂–Ω–æ –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏. –ù—É–∂–Ω—ã —Ä–µ—à–µ–Ω–∏—è —Ç–∏–ø–∞ Microsoft Defender for Identity (MDI), –∫–æ—Ç–æ—Ä—ã–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –≤ PAC.

---

### Silver Ticket

**–°—É—Ç—å:** –ï—Å–ª–∏ –∞—Ç–∞–∫—É—é—â–∏–π –ø–æ–ª—É—á–∏–ª —Ö–µ—à NTLM –º–∞—à–∏–Ω–Ω–æ–≥–æ –∏–ª–∏ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `FILESERVER01$`), –æ–Ω –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å Service Tickets –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –æ—Ç –∏–º–µ–Ω–∏ –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–í –ª–æ–≥–∞—Ö:** –ù–µ—Ç —Å–æ–±—ã—Ç–∏—è 4768/4769 –Ω–∞ DC ‚Äî Service Ticket —Å–æ–∑–¥–∞—ë—Ç—Å—è –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ KDC! –ê–Ω–æ–º–∞–ª–∏—è: –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∫ —Å–µ—Ä–≤–∏—Å—É –±–µ–∑ –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–µ–≥–æ TGS-–∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ DC.

---

## 3.2.7 Event ID –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Kerberos

| Event ID | –û–ø–∏—Å–∞–Ω–∏–µ | –ì–¥–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è | –ù–∞ —á—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å |
|----------|----------|-----------------|----------------|
| **4768** | Kerberos TGT –∑–∞–ø—Ä–æ—à–µ–Ω (AS-REQ) | DC | PreAuthType=0 ‚Üí AS-REP Roasting |
| **4769** | Kerberos Service Ticket –∑–∞–ø—Ä–æ—à–µ–Ω | DC | EncryptionType=0x17 (RC4) ‚Üí Kerberoasting; –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –æ–¥–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ |
| **4770** | Kerberos Service Ticket –æ–±–Ω–æ–≤–ª—ë–Ω | DC | –ê–Ω–æ–º–∞–ª—å–Ω–æ –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π |
| **4771** | Kerberos pre-authentication failed | DC | FailureCode=0x18 ‚Üí –Ω–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å; –±—Ä—É—Ç—Ñ–æ—Ä—Å |
| **4672** | –ü—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã | –†–∞–±–æ—á–∞—è —Å—Ç–∞–Ω—Ü–∏—è/—Å–µ—Ä–≤–µ—Ä | –ü–æ—Å–ª–µ 4624 ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –æ–∂–∏–¥–∞–ª—Å—è –ª–∏ —ç—Ç–æ—Ç –≤—Ö–æ–¥ |

### –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä Event ID 4768

```
EventID: 4768
Account Name:       john.doe
Supplied Realm Name: CORP
User ID:            S-1-5-21-...
Service Name:       krbtgt/CORP
Service ID:         S-1-5-21-...-502
Ticket Options:     0x40810010
Result Code:        0x0          ‚Üê 0x0=—É—Å–ø–µ—Ö, 0x18=–Ω–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å, 0x6=–Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞
Ticket Encryption Type: 0x12    ‚Üê 0x12=AES256, 0x17=RC4 (—Å–ª–∞–±–µ–µ)
Pre-Authentication Type: 2      ‚Üê 0=–Ω–µ—Ç (AS-REP Roastable!), 2=—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π
Client Address:     192.168.1.50
```

### –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä Event ID 4769

```
EventID: 4769
Account Name:         john.doe@CORP.LOCAL
Account Domain:       CORP.LOCAL
Logon GUID:           {GUID}
Service Name:         MSSQLSvc/sql01.corp.local:1433
Service ID:           S-1-5-21-...
Ticket Options:       0x40810000
Ticket Encryption Type: 0x17   ‚Üê RC4 ‚Üí –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è Kerberoasting!
Failure Code:         0x0
Client Address:       ::ffff:192.168.1.50
```

---

## üíª –ü—Ä–∞–∫—Ç–∏–∫–∞

### –ó–∞–¥–∞–Ω–∏–µ 1: –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è AD —Å PowerShell

```powershell
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å RSAT (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
Add-WindowsFeature RSAT-AD-PowerShell

# –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è
Import-Module ActiveDirectory

# –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–º–µ–Ω–∞
Get-ADUser -Filter * -Properties LastLogonDate, PasswordLastSet, Enabled |
    Select-Object Name, SamAccountName, Enabled, LastLogonDate, PasswordLastSet |
    Sort-Object LastLogonDate -Descending |
    Format-Table -AutoSize

# –ß–ª–µ–Ω—ã Domain Admins
Get-ADGroupMember -Identity "Domain Admins" -Recursive |
    Select-Object Name, objectClass, SamAccountName

# –ê–∫–∫–∞—É–Ω—Ç—ã —Å SPN (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π Kerberoasting)
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} `
    -Properties ServicePrincipalName |
    Select-Object Name, SamAccountName, ServicePrincipalName

# –ê–∫–∫–∞—É–Ω—Ç—ã –±–µ–∑ –ø—Ä–µ-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (AS-REP Roasting)
Get-ADUser -Filter {DoesNotRequirePreAuth -eq $true} `
    -Properties DoesNotRequirePreAuth |
    Select-Object Name, SamAccountName

# –ê–∫–∫–∞—É–Ω—Ç—ã, –Ω–µ –≤—Ö–æ–¥–∏–≤—à–∏–µ –±–æ–ª–µ–µ 90 –¥–Ω–µ–π
$cutoff = (Get-Date).AddDays(-90)
Get-ADUser -Filter {LastLogonDate -lt $cutoff -and Enabled -eq $true} `
    -Properties LastLogonDate |
    Select-Object Name, SamAccountName, LastLogonDate |
    Sort-Object LastLogonDate
```

### –ó–∞–¥–∞–Ω–∏–µ 2: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Kerberos-—Å–æ–±—ã—Ç–∏–π

```powershell
# Kerberos TGT –∑–∞–ø—Ä–æ—Å—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å (4768)
Get-WinEvent -FilterHashtable @{
    LogName   = 'Security'
    Id        = 4768
    StartTime = (Get-Date).AddHours(-1)
} | ForEach-Object {
    $xml = [xml]$_.ToXml()
    $data = $xml.Event.EventData.Data
    [PSCustomObject]@{
        Time        = $_.TimeCreated
        Account     = ($data | Where-Object Name -eq 'TargetUserName').'#text'
        PreAuthType = ($data | Where-Object Name -eq 'PreAuthType').'#text'
        EncType     = ($data | Where-Object Name -eq 'TicketEncryptionType').'#text'
        ClientIP    = ($data | Where-Object Name -eq 'IpAddress').'#text'
        ResultCode  = ($data | Where-Object Name -eq 'Status').'#text'
    }
} | Format-Table -AutoSize

# –ü–æ–∏—Å–∫ Kerberoasting: 4769 —Å RC4 (0x17)
Get-WinEvent -FilterHashtable @{
    LogName   = 'Security'
    Id        = 4769
    StartTime = (Get-Date).AddHours(-24)
} | ForEach-Object {
    $xml = [xml]$_.ToXml()
    $data = $xml.Event.EventData.Data
    $encType = ($data | Where-Object Name -eq 'TicketEncryptionType').'#text'
    if ($encType -eq '0x17') {   # RC4
        [PSCustomObject]@{
            Time        = $_.TimeCreated
            Account     = ($data | Where-Object Name -eq 'TargetUserName').'#text'
            Service     = ($data | Where-Object Name -eq 'ServiceName').'#text'
            EncType     = $encType
            ClientIP    = ($data | Where-Object Name -eq 'IpAddress').'#text'
        }
    }
} | Format-Table -AutoSize
```

### –ó–∞–¥–∞–Ω–∏–µ 3: –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏–∫

```powershell
# –†–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
gpresult /r /scope user

# HTML-–æ—Ç—á—ë—Ç (–±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π)
gpresult /h C:\Temp\gpo_report.html /f
Start-Process C:\Temp\gpo_report.html

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫
gpupdate /force
```

---

## üõ†Ô∏è –ó–∞–¥–∞–Ω–∏—è

### –ó–∞–¥–∞–Ω–∏–µ 1 ‚≠ê ‚Äî –ö–µ—Ä–±–µ—Ä–æc –Ω–∞ –ø–∞–ª—å—Ü–∞—Ö

–û–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ (–±–µ–∑ —É—á–µ–±–Ω–∏–∫–∞) —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `john.doe` —Å–∞–¥–∏—Ç—Å—è –∑–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä –∏ –≤–≤–æ–¥–∏—Ç –ø–∞—Ä–æ–ª—å ‚Äî —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—à–∞–≥–æ–≤–æ –≤ Kerberos?
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `\\fileserver\share` ‚Äî –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ Kerberos-—Å—Ü–µ–Ω–∞—Ä–∏—è.
3. –ü–æ—á–µ–º—É –ø—Ä–∏ Kerberoasting –∞—Ç–∞–∫—É—é—â–∏–π –º–æ–∂–µ—Ç –≤–∑–ª–æ–º–∞—Ç—å —Ö–µ—à –æ—Ñ—Ñ–ª–∞–π–Ω? –ö–∞–∫—É—é —á–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ KDC –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç?

---

### –ó–∞–¥–∞–Ω–∏–µ 2 ‚≠ê‚≠ê ‚Äî –ê—É–¥–∏—Ç AD –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏

–ò—Å–ø–æ–ª—å–∑—É—è PowerShell (–∏–ª–∏ Active Directory Users and Computers GUI), –ø—Ä–æ–≤–µ–¥–∏—Ç–µ –∞—É–¥–∏—Ç —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –¥–æ–º–µ–Ω–∞:

1. –ù–∞–π–¥–∏—Ç–µ –≤—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã —Å —Ñ–ª–∞–≥–æ–º `DoesNotRequirePreAuth`
2. –ù–∞–π–¥–∏—Ç–µ –≤—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã —Å SPN (ServicePrincipalName)
3. –ù–∞–π–¥–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã —Å –ø–∞—Ä–æ–ª–µ–º, –Ω–µ –∏—Å—Ç–µ–∫–∞—é—â–∏–º –Ω–∏–∫–æ–≥–¥–∞ (`PasswordNeverExpires`)
4. –ù–∞–π–¥–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã, –Ω–µ –≤—Ö–æ–¥–∏–≤—à–∏–µ –±–æ–ª–µ–µ 90 –¥–Ω–µ–π, –Ω–æ Enabled
5. –ù–∞–π–¥–∏—Ç–µ —á–ª–µ–Ω–æ–≤ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø (Domain Admins, Enterprise Admins)
6. –°–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ç—á—ë—Ç —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∫–∞–∂–¥–æ–π –ø—Ä–æ–±–ª–µ–º—ã

---

### –ó–∞–¥–∞–Ω–∏–µ 3 ‚≠ê‚≠ê‚≠ê ‚Äî –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ Kerberoasting

–†–∞–∑—Ä–∞–±–æ—Ç–∞–π—Ç–µ PowerShell-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Kerberoasting:

1. –ß–∏—Ç–∞–µ—Ç Security EventLog –Ω–∞ DC –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —á–∞—Å–æ–≤
2. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤—Å–µ —Å–æ–±—ã—Ç–∏—è 4769 —Å `TicketEncryptionType = 0x17` (RC4)
3. –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –ø–æ `TargetUserName` (–∫–ª–∏–µ–Ω—Ç, –¥–µ–ª–∞—é—â–∏–π –∑–∞–ø—Ä–æ—Å—ã)
4. –í—ã–≤–æ–¥–∏—Ç –∞–ª–µ—Ä—Ç, –µ—Å–ª–∏ –æ–¥–∏–Ω –∞–∫–∫–∞—É–Ω—Ç –∑–∞–ø—Ä–æ—Å–∏–ª ST –∫ –±–æ–ª–µ–µ —á–µ–º 3 —Ä–∞–∑–Ω—ã–º SPN –∑–∞ 1 —á–∞—Å
5. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –∫—Ä–æ—Å—Å-—Ä–µ—Ñ–µ—Ä–µ–Ω—Å —Å Get-ADUser ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ SPN (—Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞)

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
```
[ALERT] Possible Kerberoasting detected!
Client Account: CORP\attacker
Time Window:    2025-01-15 14:00:00 - 14:02:30
SPNs Requested: 7
  - MSSQLSvc/sql01.corp.local:1433 (owner: svc_mssql, weakpassword: likely)
  - http/webapp.corp.local (owner: svc_iis)
  - ...
Recommendation: Check if svc_mssql password is strong (>25 chars random)
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –Ø –º–æ–≥—É –æ–±—ä—è—Å–Ω–∏—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –¥–æ–º–µ–Ω–æ–º, –¥–µ—Ä–µ–≤–æ–º –∏ –ª–µ—Å–æ–º AD
- [ ] –Ø –ø–æ–Ω–∏–º–∞—é —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É OU –∏ Group
- [ ] –Ø –∑–Ω–∞—é, —á—Ç–æ —Ç–∞–∫–æ–µ LSDOU –∏ –≤ –∫–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è GPO
- [ ] –Ø –ø–æ–Ω–∏–º–∞—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É Distinguished Name –∏ –º–æ–≥—É –µ–≥–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å
- [ ] –Ø –º–æ–≥—É –ø–æ—à–∞–≥–æ–≤–æ –æ–ø–∏—Å–∞—Ç—å Kerberos-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é: AS-REQ, AS-REP, TGS-REQ, TGS-REP, AP-REQ
- [ ] –Ø –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ —Ç–∞–∫–æ–µ TGT, Service Ticket, SPN, PAC
- [ ] –Ø –∑–Ω–∞—é, —á—Ç–æ —Ç–∞–∫–æ–µ Kerberoasting –∏ –ø–æ—á–µ–º—É –≤–æ–∑–º–æ–∂–µ–Ω –æ—Ñ—Ñ–ª–∞–π–Ω-–≤–∑–ª–æ–º
- [ ] –Ø –∑–Ω–∞—é, —á—Ç–æ —Ç–∞–∫–æ–µ AS-REP Roasting –∏ —Ñ–ª–∞–≥ DONT_REQ_PREAUTH
- [ ] –Ø –ø–æ–Ω–∏–º–∞—é —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É Golden –∏ Silver Ticket
- [ ] –Ø –∑–Ω–∞—é Event ID 4768, 4769, 4771 –∏ —É–º–µ—é –∏—Å–∫–∞—Ç—å –≤ –Ω–∏—Ö –∞–Ω–æ–º–∞–ª–∏–∏
- [ ] –Ø —É–º–µ—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PowerShell –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ AD (Get-ADUser, Get-ADGroupMember)

---

## üîó –†–µ—Å—É—Ä—Å—ã

- [Microsoft Docs ‚Äî Active Directory Domain Services](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview)
- [HarmJ0y ‚Äî Kerberoasting Without Mimikatz](https://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/)
- [Sean Metcalf ‚Äî Attack Methods for Gaining Domain Admin Rights](https://adsecurity.org/?p=2362)
- [MITRE ATT&CK ‚Äî Steal or Forge Kerberos Tickets](https://attack.mitre.org/techniques/T1558/)
- [Microsoft Defender for Identity ‚Äî Kerberos Detection](https://docs.microsoft.com/en-us/defender-for-identity/lateral-movement-alerts)
- [Kerberos Explained (Rootsec)](https://www.rootsec.org/kerberos-authentication/)
- [Impacket ‚Äî Python toolkit for AD attacks/analysis](https://github.com/fortra/impacket)
